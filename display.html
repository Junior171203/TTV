<!DOCTYPE html>
<html lang="ru">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>–í—Ö–æ–¥—è—à–∫–∏</title>

    <style>
      html,
      body {
        margin: 0;
        padding: 0;
        height: 100%;
        font-family: Arial, sans-serif;

        /* –ù–û–í–ê–Ø –ü–ê–õ–ò–¢–†–ê –§–û–ù–ê (—Å–ª–∏–≤–∞ + —Ä–æ–∑–æ–≤–æ–µ —Å–≤–µ—á–µ–Ω–∏–µ) */
        background:
          radial-gradient(circle, #2a0e2a 40%, #0a050a 100%),
          radial-gradient(circle at 20% 30%, #ff9bd8 1px, transparent 2px),
          radial-gradient(circle at 80% 70%, #ff9bd8 1px, transparent 2px),
          radial-gradient(circle at 50% 50%, #ff9bd8 1px, transparent 2px);
        background-repeat: no-repeat;
        background-size: cover;

        color: #eaf3ff; /* –æ–±—â–∏–π —Ç–µ–∫—Å—Ç */
        transition: background 0.5s ease, color 0.5s ease;
      }

      #backgroundText,
      #message {
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        display: flex;
        justify-content: center;
        align-items: center;
        text-align: center;
        white-space: pre-line;
        flex-direction: column;
      }

      #backgroundText {
        font-size: 2.5em;
        z-index: 1;
      }

      #message {
        font-size: 3.5em;
        z-index: 2;

        /* –±–∞–Ω–Ω–µ—Ä —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π ‚Äî —Ü–≤–µ—Ç–∞ –ø—Ä–µ–∂–Ω–∏–µ */
        color: #172333;
        background: linear-gradient(135deg, #c8f1ff, #d7c4ff);
        box-shadow: 0 4px 15px rgba(10, 60, 120, 0.45);
        border-radius: 12px;
        padding: 3rem 4rem;
        display: none;
        user-select: none;
        line-height: 1.2;
      }

      #enableSound {
        position: absolute;
        top: 10px;
        right: 10px;
        z-index: 1000;
        padding: 10px 20px;
        font-size: 1em;
        background: #222;
        color: white;
        border: none;
        border-radius: 5px;
        cursor: pointer;
      }

      /* –¢–∞–±–ª–∏—Ü–∞ */
      #backgroundText table {
        margin: auto;
        font-family: monospace;
        border-collapse: collapse;
        user-select: none;
        color: #eaf3ff;
      }

      #backgroundText td {
        padding: 2px 10px;
        border: 1px solid #4d5a70;
        white-space: nowrap;
        color: #eaf3ff;
        text-shadow: none;
        position: relative;
        transition: background-color 0.3s ease;
      }

      /* –í—ã—Ä–∞–≤–Ω–∏–≤–∞–Ω–∏–µ: –∑–∞–≥–æ–ª–æ–≤–∫–∏ –ø–æ —Ü–µ–Ω—Ç—Ä—É, –ø–µ—Ä–≤—ã–π —Å—Ç–æ–ª–±–µ—Ü (U2:U8) ‚Äî –≤–ª–µ–≤–æ, –æ—Å—Ç–∞–ª—å–Ω—ã–µ –ø–æ —Ü–µ–Ω—Ç—Ä—É */
      #backgroundText tr:first-child td { text-align: center; }
      #backgroundText td:first-child { text-align: left; }
      #backgroundText tr td:not(:first-child) { text-align: center; }

      /* –ó–∞–≥–æ–ª–æ–≤–∫–∏ */
      #backgroundText tr:first-child td {
        font-weight: bold;
        color: #8affd0;
        text-shadow: 0 0 12px rgba(138, 255, 208, 0.8), 0 0 20px rgba(126, 249, 255, 0.6);
        animation: pulseGlow 2s infinite alternate;
      }

      /* –ú–µ–¥–∞–ª–∏ ‚Äî –±–µ–∑ –∞–Ω–∏–º–∞—Ü–∏–π */
      #backgroundText td:has(> .medal),
      #backgroundText td:contains("ü•á"),
      #backgroundText td:contains("ü•à"),
      #backgroundText td:contains("ü•â") {
        animation: none !important;
        color: #eaf3ff;
        text-shadow: none;
      }

      /* –ü–æ–¥—Å–≤–µ—Ç–∫–∞ —Å—Ç—Ä–æ–∫ */
      @keyframes rowHighlight {
        0%   { background-color: transparent; }
        50%  { background-color: rgba(126, 249, 255, 0.22); }
        100% { background-color: transparent; }
      }
    </style>
  </head>

  <body>
    <div id="backgroundText">–ó–∞–≥—Ä—É–∑–∫–∞...</div>
    <div id="message"></div>
    <button id="enableSound">üîä –í–∫–ª—é—á–∏—Ç—å –∑–≤—É–∫</button>

    <audio id="notifySound" src="mamont2.mp3"></audio>
    <audio id="sitdownSound" src="sitdown.mp3"></audio>
    <audio id="moneySound" src="money2.mp3"></audio>

    <script>
      const bgDiv = document.getElementById('backgroundText');
      const msgDiv = document.getElementById('message');
      const notifySound = document.getElementById('notifySound');
      const sitdownSound = document.getElementById('sitdownSound');
      const moneySound = document.getElementById('moneySound'); // NEW
      const soundBtn = document.getElementById('enableSound');

      let queue = [];
      let showingNotification = false;
      let lastBgIncludedSitdown = false;

      // –í–û–°–°–¢–ê–ù–û–í–õ–ï–ù–ò–ï –§–û–ù–ê ‚Äî –°–û–û–¢–í–ï–¢–°–¢–í–£–ï–¢ –ù–û–í–û–ô –ü–ê–õ–ò–¢–†–ï
      const defaultBackground =
        'radial-gradient(circle, #2a0e2a 40%, #0a050a 100%),' +
        'radial-gradient(circle at 20% 30%, #ff9bd8 1px, transparent 2px),' +
        'radial-gradient(circle at 80% 70%, #ff9bd8 1px, transparent 2px),' +
        'radial-gradient(circle at 50% 50%, #ff9bd8 1px, transparent 2px)';
      const defaultColor = '#eaf3ff';

      soundBtn.addEventListener('click', () => {
        notifySound
          .play()
          .then(() => {
            notifySound.pause();
            notifySound.currentTime = 0;
            return sitdownSound.play();
          })
          .then(() => {
            sitdownSound.pause();
            sitdownSound.currentTime = 0;
            return moneySound.play(); // ¬´—Ä–∞–∑–±—É–¥–∏—Ç—å¬ª money2.mp3
          })
          .then(() => {
            moneySound.pause();
            moneySound.currentTime = 0;
            soundBtn.style.display = 'none';
          })
          .catch((e) => {
            alert('–ë—Ä–∞—É–∑–µ—Ä –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–ª –∑–≤—É–∫. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –µ—â—ë —Ä–∞–∑.');
            console.error(e);
          });
      });

      async function fetchBackground() {
        try {
          const res = await fetch(
            'https://script.google.com/macros/s/AKfycbxVVkIad26K7uwn36VfVO7xcCUe_OeGzC2flVEX3fKsDM9aCiftGdktNI0oLvH9Ho_w/exec?bg=1'
          );
          const values = await res.json();

          let html = '<table>';
          values.forEach((row) => {
            html += '<tr>';
            if (Array.isArray(row)) {
              let filteredRow = row.slice();
              while (filteredRow.length && filteredRow[filteredRow.length - 1] === '') {
                filteredRow.pop();
              }
              filteredRow.forEach((cell) => {
                html += `<td>${cell}</td>`;
              });
            } else {
              html += `<td>${row}</td>`;
            }
            html += '</tr>';
          });
          html += '</table>';
          bgDiv.innerHTML = html;

          applyRowHighlightAnimation();

          const flatValues = values.flat().join(' ').toLowerCase();
          const containsSitdown = flatValues.includes('–º–æ–∂–µ–º —Å–∞–¥–∏—Ç—å—Å—è');

          if (containsSitdown && !lastBgIncludedSitdown) {
            showSitdown();
          }

          lastBgIncludedSitdown = containsSitdown;
        } catch (e) {
          bgDiv.textContent = '–¢–∞ –±–ª—è, –∏–Ω—Ç–µ—Ä–Ω–µ—Ç —Å–ª–µ—Ç–µ–ª: ' + e.message;
          console.error(e);
        }
      }

      function applyRowHighlightAnimation() {
        const rows = bgDiv.querySelectorAll('table tr');
        rows.forEach((row, index) => {
          row.style.animation = `rowHighlight 3s ease-in-out infinite`;
          row.style.animationDelay = `${index * 0.5}s`;
        });
      }

      function showSitdown() {
        if (showingNotification) return;

        showingNotification = true;
        msgDiv.textContent = '–ú–û–ñ–ï–ú –°–ê–î–ò–¢–¨–°–Ø';
        msgDiv.style.display = 'flex';
        bgDiv.style.display = 'none';

        document.body.style.background =
          'linear-gradient(135deg, #c8f1ff, #d7c4ff)';
        document.body.style.color = '#172333';

        sitdownSound.play().catch(console.error);

        setTimeout(() => {
          msgDiv.style.display = 'none';
          bgDiv.style.display = 'flex';

          document.body.style.background = defaultBackground;
          document.body.style.color = defaultColor;

          showingNotification = false;
        }, 20000);

        setTimeout(() => {
          sitdownSound.pause();
          sitdownSound.currentTime = 0;
        }, 5000);
      }

      function showDelta(deltaText) {
        if (showingNotification) return;
        showingNotification = true;

        const pure = String(deltaText).replace(/^DELTA:/, '').trim();
        const banner = `–ó–∞–Ω–æ—Å –æ—Ç –º–∞–º–æ–Ω—Ç–∞ ${pure}—Ä`;

        msgDiv.textContent = banner;
        msgDiv.style.display = 'flex';
        bgDiv.style.display = 'none';

        document.body.style.background =
          'linear-gradient(135deg, #c8f1ff, #d7c4ff)';
        document.body.style.color = '#172333';

        if (pure.startsWith('+')) {
          msgDiv.style.boxShadow = '0 4px 18px rgba(20, 200, 140, 0.55)';
        } else {
          msgDiv.style.boxShadow = '0 4px 18px rgba(225, 70, 70, 0.55)';
        }

        moneySound.currentTime = 0;
        moneySound.play().catch(console.error);

        setTimeout(() => {
          msgDiv.style.display = 'none';
          bgDiv.style.display = 'flex';

          document.body.style.background = defaultBackground;
          document.body.style.color = defaultColor;
          msgDiv.style.boxShadow = '0 4px 15px rgba(10, 60, 120, 0.45)';

          showingNotification = false;
          if (queue.length > 0) showNextMessage();
        }, 20000);

        setTimeout(() => {
          moneySound.pause();
          moneySound.currentTime = 0;
        }, 20000);
      }

      async function fetchMessages() {
        if (showingNotification || queue.length > 0) return;

        try {
          const res = await fetch(
            'https://script.google.com/macros/s/AKfycbxVVkIad26K7uwn36VfVO7xcCUe_OeGzC2flVEX3fKsDM9aCiftGdktNI0oLvH9Ho_w/exec'
          );
          const messages = await res.json();
          const filtered = messages.filter(
            (msg) => !String(msg).toLowerCase().includes('–º–æ–∂–µ–º —Å–∞–¥–∏—Ç—å—Å—è')
          );

          if (filtered.length > 0) {
            queue.push(...filtered);
            showNextMessage();
          }
        } catch (e) {
          console.error('–û—à–∏–±–∫–∞ –ø–æ–ª—É—á–µ–Ω–∏—è —Å–æ–æ–±—â–µ–Ω–∏–π:', e);
        }
      }

      function showNextMessage() {
        if (queue.length === 0) return;

        const message = queue.shift();
        if (String(message).startsWith('DELTA:')) {
          showDelta(String(message));
          return;
        }

        showingNotification = true;

        msgDiv.textContent = message;
        msgDiv.style.display = 'flex';
        bgDiv.style.display = 'none';

        document.body.style.background =
          'linear-gradient(135deg, #c8f1ff, #d7c4ff)';
        document.body.style.color = '#172333';

        notifySound.play().catch(console.error);

        setTimeout(() => {
          msgDiv.style.display = 'none';
          bgDiv.style.display = 'flex';

          document.body.style.background = defaultBackground;
          document.body.style.color = defaultColor;

          showingNotification = false;

          if (queue.length > 0) showNextMessage();
        }, 20000);

        setTimeout(() => {
          notifySound.pause();
          notifySound.currentTime = 0;
        }, 5000);
      }

      fetchBackground();
      setInterval(fetchBackground, 30000);
      setInterval(fetchMessages, 5000);
    </script>
  </body>
</html>
