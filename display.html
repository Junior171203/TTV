<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>–í—Ö–æ–¥—è—à–∫–∏</title>

  <!-- –®—Ä–∏—Ñ—Ç —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Manrope:wght@600;700&display=swap" rel="stylesheet">

  <style>
    :root{
      --txt:#fff9fb; --muted:#d8cfe2;
      --p1:#ff73d9; --p2:#ffcf6b; --p3:#b07cff; --p4:#6affb2;
      --glassTop: rgba(30,16,34,.92); --glassMid: rgba(30,16,34,.70);
      --grid: rgba(255,255,255,.08); --border: rgba(255,255,255,.16);
      --shadow: 0 28px 90px rgba(0,0,0,.55);
    }

    html, body {
      margin:0; padding:0; height:100%;
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, "Inter", Arial, sans-serif;
      background:
        radial-gradient(circle at 50% 20%, #2a0e2a 0%, #120811 50%, #070407 100%),
        radial-gradient(circle at 15% 80%, #2b0f23 0%, transparent 60%),
        radial-gradient(circle at 82% 75%, #21112b 0%, transparent 60%);
      color: var(--txt); overflow:hidden; transition: background .5s ease, color .5s ease;
    }

    .fx-aurora,.fx-aurora2{position:fixed;inset:-25%;z-index:-3;pointer-events:none;filter:blur(80px);opacity:.9;animation:aurora 60s linear infinite}
    .fx-aurora{background:conic-gradient(from 120deg,rgba(255,115,217,.28),rgba(255,207,107,.28),rgba(176,124,255,.28),rgba(106,255,178,.24),rgba(255,115,217,.28))}
    .fx-aurora2{background:conic-gradient(from 300deg,rgba(176,124,255,.24),rgba(255,115,217,.24),rgba(255,207,107,.24),rgba(106,255,178,.22),rgba(176,124,255,.24));animation-direction:reverse;animation-duration:85s}
    @keyframes aurora{to{transform:rotate(360deg)}}
    .fx-beams{position:fixed;inset:-20% -25%;z-index:-2;pointer-events:none;mix-blend-mode:screen;opacity:.55;background:
      linear-gradient(115deg,rgba(255,115,217,.22) 0%,transparent 55%),
      linear-gradient(245deg,rgba(255,207,107,.22) 0%,transparent 55%),
      linear-gradient(60deg,rgba(176,124,255,.20) 0%,transparent 55%);animation:sweep 16s linear infinite}
    @keyframes sweep{0%{transform:translate(-5%,0)}50%{transform:translate(5%,0)}100%{transform:translate(-5%,0)}}
    .fx-grid{position:fixed;inset:0;z-index:-1;pointer-events:none;opacity:.15;background:
      repeating-linear-gradient(0deg,rgba(255,255,255,.08) 0 1px,transparent 1px 24px),
      repeating-linear-gradient(90deg,rgba(255,255,255,.08) 0 1px,transparent 1px 24px)}
    .tv{position:fixed;inset:10px;border-radius:28px;z-index:-1;pointer-events:none;overflow:hidden;box-shadow:inset 0 0 0 2px rgba(255,255,255,.08),inset 0 0 160px rgba(0,0,0,.6),0 26px 80px rgba(0,0,0,.42);filter:saturate(1.15) contrast(1.06);isolation:isolate}
    .tv::before{content:"";position:absolute;inset:-3px;border-radius:31px;z-index:2;background:conic-gradient(from 0deg,#ff73d9,#ffcf6b,#b07cff,#6affb2,#ff73d9);animation:spin 10s linear infinite;-webkit-mask:linear-gradient(#000 0 0) content-box,linear-gradient(#000 0 0);mask:linear-gradient(#000 0 0) content-box,linear-gradient(#000 0 0);-webkit-mask-composite:xor;mask-composite:exclude;padding:3px;filter:blur(.25px)}
    .scan{position:absolute;inset:0;border-radius:inherit;z-index:1;opacity:.10;background:repeating-linear-gradient(0deg,rgba(255,255,255,.18) 0 1px,transparent 1px 3px);animation:scan 7s linear infinite}
    @keyframes scan{to{background-position:0 240px}} @keyframes spin{to{transform:rotate(360deg)}}

    #enableSound{position:absolute;top:12px;right:14px;z-index:10000;padding:12px 16px;font-size:14px;font-weight:800;background:linear-gradient(135deg,#ff73d9,#ffcf6b);color:#2b1026;border:none;border-radius:12px;cursor:pointer;box-shadow:var(--shadow);transition:transform .15s}
    #enableSound:hover{transform:translateY(-1px)} #enableSound:active{transform:translateY(0) scale(.98)}

    #backgroundText,#message{position:fixed;inset:0;display:flex;justify-content:center;align-items:center;flex-direction:column;text-align:center;white-space:pre-line;padding:2rem}

    /* === –¢–û–õ–¨–ö–û –†–ê–ó–ú–ï–†–´ –¢–ï–ö–°–¢–ê –§–û–ù–û–í–û–ô –¢–ê–ë–õ–ò–¶–´ –£–í–ï–õ–ò–ß–ï–ù–´ === */
    #backgroundText{z-index:10;font-size:clamp(24px,1.8vw,36px);color:var(--txt)}
    #backgroundText table{margin:auto;border-collapse:separate;border-spacing:0;font-family:ui-monospace,SFMono-Regular,Menlo,Consolas,monospace;color:var(--txt);background:linear-gradient(180deg,var(--glassTop),var(--glassMid));border:1px solid var(--border);border-radius:16px;overflow:hidden;backdrop-filter:blur(12px);box-shadow:var(--shadow)}
    #backgroundText tr:first-child td{font-weight:900;font-size:clamp(28px,2.2vw,42px);letter-spacing:.35px;color:#FFE39A;background:linear-gradient(180deg,rgba(42,18,50,.96),rgba(42,18,50,.84));text-shadow:0 0 16px rgba(255,207,107,.45),0 0 24px rgba(176,124,255,.35);border-bottom:1px solid var(--border)}
    #backgroundText tr:first-child td:not(:last-child){box-shadow:inset -1px 0 0 rgba(255,255,255,.06)}
    #backgroundText td{padding:14px 20px;border-bottom:1px solid rgba(255,255,255,.06);white-space:nowrap;color:#fff9fb;transition:background-color .25s}
    #backgroundText tr:nth-child(odd) td{background:linear-gradient(180deg,rgba(255,255,255,.02),rgba(255,255,255,.00))}
    #backgroundText tr:hover td{background-color:rgba(255,115,217,.11)}

    /* —Ü–µ–Ω—Ç—Ä –¥–ª—è 2 –∏ 3 –∫–æ–ª–æ–Ω–æ–∫, –∫–∞–∫ –±—ã–ª–æ */
    #backgroundText td:nth-child(2),
    #backgroundText td:nth-child(3){text-align:center;font-variant-numeric:tabular-nums;letter-spacing:.03em}

    /* –≤—ã—Ä–∞–≤–Ω–∏–≤–∞–Ω–∏–µ –≤–ª–µ–≤–æ —Ç–æ–ª—å–∫–æ 1-–π –∫–æ–ª–æ–Ω–∫–∏ (U2:U8), –∫–∞–∫ –ø—Ä–æ—Å–∏–ª–∏ —Ä–∞–Ω–µ–µ */
    #backgroundText td:first-child{
      text-align:left !important;
      padding-left:24px;
    }

    /* === —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –ù–ï —Ç—Ä–æ–≥–∞—é === */
    #message{
      z-index:99999; display:none; pointer-events:none;
      font-family:"Manrope", ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, "Inter", Arial, sans-serif;
      font-weight:700; font-size:clamp(42px,7.4vw,120px); line-height:1.06; letter-spacing:.02em;
      color:#FFE39A;
      -webkit-text-stroke:0!important;
      text-shadow:0 1px 0 rgba(25,10,22,.70),0 -1px 0 rgba(25,10,22,.70),1px 0 0 rgba(25,10,22,.70),-1px 0 0 rgba(25,10,22,.70),0 14px 28px rgba(0,0,0,.35);
      background:none; padding:0;
    }
    #message::before{
      content:""; position:fixed; inset:0; z-index:-2;
      background: radial-gradient(1100px 700px at 50% 50%, rgba(40,14,38,.92), rgba(18,7,16,.92));
      backdrop-filter: blur(10px);
    }
    #message::after{ content:none; }
  </style>
</head>
<body>
  <div class="fx-aurora"></div>
  <div class="fx-aurora2"></div>
  <div class="fx-beams"></div>
  <div class="tv"><div class="scan"></div></div>
  <div class="fx-grid"></div>

  <div id="backgroundText">–ó–∞–≥—Ä—É–∑–∫–∞...</div>
  <div id="message"></div>
  <button id="enableSound">üîä –í–∫–ª—é—á–∏—Ç—å –∑–≤—É–∫</button>

  <audio id="notifySound" src="mamont2.mp3"></audio>
  <audio id="sitdownSound" src="sitdown.mp3"></audio>
  <audio id="moneySound" src="money2.mp3"></audio>

  <script>
    /* –ª–æ–≥–∏–∫–∞ ‚Äî –±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π */
    const bgDiv = document.getElementById('backgroundText');
    const msgDiv = document.getElementById('message');
    const notifySound = document.getElementById('notifySound');
    const sitdownSound = document.getElementById('sitdownSound');
    const moneySound  = document.getElementById('moneySound');
    const soundBtn = document.getElementById('enableSound');

    let queue = [];
    let showingNotification = false;
    let lastBgIncludedSitdown = false;

    const defaultBackground =
      'radial-gradient(circle at 50% 20%, #2a0e2a 0%, #120811 50%, #070407 100%),' +
      'radial-gradient(circle at 15% 80%, #2b0f23 0%, transparent 60%),' +
      'radial-gradient(circle at 82% 75%, #21112b 0%, transparent 60%)';
    const defaultColor = '#fff9fb';

    soundBtn.addEventListener('click', () => {
      notifySound.play().then(() => {
        notifySound.pause(); notifySound.currentTime = 0;
        return sitdownSound.play();
      }).then(() => {
        sitdownSound.pause(); sitdownSound.currentTime = 0;
        return moneySound.play();
      }).then(() => {
        moneySound.pause(); moneySound.currentTime = 0;
        soundBtn.style.display = 'none';
      }).catch(e => {
        alert("–ë—Ä–∞—É–∑–µ—Ä –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–ª –∑–≤—É–∫. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –µ—â—ë —Ä–∞–∑.");
        console.error(e);
      });
    });

    async function fetchBackground() {
      try {
        const res = await fetch('https://script.google.com/macros/s/AKfycbxVVkIad26K7uwn36VfVO7xcCUe_OeGzC2flVEX3fKsDM9aCiftGdktNI0oLvH9Ho_w/exec?bg=1');
        const values = await res.json();

        let html = '<table>';
        values.forEach(row => {
          html += '<tr>';
          if (Array.isArray(row)) {
            let filteredRow = row.slice();
            while (filteredRow.length && filteredRow[filteredRow.length - 1] === "") filteredRow.pop();
            filteredRow.forEach(cell => { html += `<td>${cell}</td>`; });
          } else {
            html += `<td>${row}</td>`;
          }
          html += '</tr>';
        });
        html += '</table>';
        bgDiv.innerHTML = html;

        applyRowHighlightAnimation();

        const flatValues = values.flat().join(' ').toLowerCase();
        const containsSitdown = flatValues.includes('–º–æ–∂–µ–º —Å–∞–¥–∏—Ç—å—Å—è');
        if (containsSitdown && !lastBgIncludedSitdown) showSitdown();
        lastBgIncludedSitdown = containsSitdown;
      } catch (e) {
        bgDiv.textContent = '–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö: ' + e.message;
        console.error(e);
      }
    }

    function applyRowHighlightAnimation() {
      const rows = bgDiv.querySelectorAll('table tr');
      rows.forEach((row, index) => {
        row.style.animation = `rowHighlight 3s ease-in-out infinite`;
        row.style.animationDelay = `${index * 0.5}s`;
      });
    }

    function showSitdown() {
      if (showingNotification) return;
      showingNotification = true;

      msgDiv.textContent = '–ú–û–ñ–ï–ú –°–ê–î–ò–¢–¨–°–Ø';
      msgDiv.style.display = 'flex';
      bgDiv.style.display = 'none';

      document.body.style.background = 'linear-gradient(135deg, #e0f0ff, #a0c8ff)';
      document.body.style.color = '#073763';

      sitdownSound.play().catch(console.error);

      setTimeout(() => {
        msgDiv.style.display = 'none';
        bgDiv.style.display = 'flex';
        document.body.style.background = defaultBackground;
        document.body.style.color = defaultColor;
        showingNotification = false;
      }, 20000);

      setTimeout(() => { sitdownSound.pause(); sitdownSound.currentTime = 0; }, 5000);
    }

    function showDelta(deltaText) {
      if (showingNotification) return;
      showingNotification = true;

      const pure = String(deltaText).replace(/^DELTA:/, '').trim();
      const banner = `–ó–∞–Ω–æ—Å –æ—Ç –º–∞–º–æ–Ω—Ç–∞ ${pure}—Ä`;

      msgDiv.textContent = banner;
      msgDiv.style.display = 'flex';
      bgDiv.style.display = 'none';

      document.body.style.background = 'linear-gradient(135deg, #e0f0ff, #a0c8ff)';
      document.body.style.color = '#073763';

      msgDiv.style.boxShadow = pure.startsWith('+')
        ? '0 6px 30px rgba(40, 200, 120, 0.55)'
        : '0 6px 30px rgba(220, 60, 60, 0.55)';

      moneySound.currentTime = 0;
      moneySound.play().catch(console.error);

      setTimeout(() => {
        msgDiv.style.display = 'none';
        bgDiv.style.display = 'flex';
        document.body.style.background = defaultBackground;
        document.body.style.color = defaultColor;
        msgDiv.style.boxShadow = '0 24px 80px rgba(0,0,0,.45)';
        showingNotification = false;
        if (queue.length > 0) showNextMessage();
      }, 20000);

      setTimeout(() => { moneySound.pause(); moneySound.currentTime = 0; }, 20000);
    }

    async function fetchMessages() {
      if (showingNotification || queue.length > 0) return;
      try {
        const res = await fetch('https://script.google.com/macros/s/AKfycbxVVkIad26K7uwn36VfVO7xcCUe_OeGzC2flVEX3fKsDM9aCiftGdktNI0oLvH9Ho_w/exec');
        const messages = await res.json();
        const filtered = messages.filter(msg => !String(msg).toLowerCase().includes('–º–æ–∂–µ–º —Å–∞–¥–∏—Ç—å—Å—è'));
        if (filtered.length > 0) {
          queue.push(...filtered);
          showNextMessage();
        }
      } catch (e) {
        console.error('–û—à–∏–±–∫–∞ –ø–æ–ª—É—á–µ–Ω–∏—è —Å–æ–æ–±—â–µ–Ω–∏–π:', e);
      }
    }

    function showNextMessage() {
      if (queue.length === 0) return;

      const message = queue.shift();
      if (String(message).startsWith('DELTA:')) { showDelta(String(message)); return; }

      showingNotification = true;
      msgDiv.textContent = message;
      msgDiv.style.display = 'flex';
      bgDiv.style.display = 'none';

      document.body.style.background = 'linear-gradient(135deg, #e0f0ff, #a0c8ff)';
      document.body.style.color = '#073763';

      notifySound.play().catch(console.error);

      setTimeout(() => {
        msgDiv.style.display = 'none';
        bgDiv.style.display = 'flex';
        document.body.style.background = defaultBackground;
        document.body.style.color = defaultColor;
        showingNotification = false;
        if (queue.length > 0) showNextMessage();
      }, 20000);

      setTimeout(() => { notifySound.pause(); notifySound.currentTime = 0; }, 5000);
    }

    fetchBackground();
    setInterval(fetchBackground, 30000);
    setInterval(fetchMessages, 5000);
  </script>
</body>
</html>
