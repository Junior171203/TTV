<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>–í—Ö–æ–¥—è—à–∫–∏</title>
  <style>
    html, body {
      margin: 0;
      padding: 0;
      height: 100%;
      font-family: 'Arial', sans-serif;
      background: black;
      color: #ddd;
      display: flex;
      justify-content: center;
      align-items: center;
      font-size: 1.5em;
    }

    #container {
      display: flex;
      gap: 30px;
      justify-content: center;
      align-items: flex-start;
      flex-wrap: wrap;
      max-width: 1200px;
      margin: 20px;
    }

    .column {
      flex: 1 1 45%;
      min-width: 300px;
      padding: 10px;
      background-color: #222;
      border-radius: 10px;
      box-shadow: 0 0 10px rgba(0, 0, 0, 0.5);
      margin: 10px;
      color: #fff;
    }

    .column h2 {
      text-align: center;
      color: #FFD700;
      font-size: 1.8em;
      margin-bottom: 20px;
    }

    .row {
      display: flex;
      justify-content: space-between;
      padding: 8px 0;
    }

    .row span {
      display: inline-block;
      width: 45%;
      text-align: left;
      overflow: hidden;
      white-space: nowrap;
      text-overflow: ellipsis;
    }

    #message {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      display: none;
      justify-content: center;
      align-items: center;
      font-size: 3.5em;
      color: black;
      background: white;
      z-index: 10;
      padding: 2rem;
      text-align: center;
    }

    #enableSound {
      position: absolute;
      top: 10px;
      right: 10px;
      z-index: 1000;
      padding: 10px 20px;
      font-size: 1em;
      background: #222;
      color: white;
      border: none;
      border-radius: 5px;
      cursor: pointer;
    }
  </style>
</head>
<body>
  <div id="message"></div>
  <button id="enableSound">üîä –í–∫–ª—é—á–∏—Ç—å –∑–≤—É–∫</button>

  <audio id="notifySound" src="mamont2.mp3"></audio>
  <audio id="sitdownSound" src="sitdown.mp3"></audio>

  <div id="container">
    <div class="column" id="col1">–ó–∞–≥—Ä—É–∑–∫–∞...</div>
    <div class="column" id="col2">–ó–∞–≥—Ä—É–∑–∫–∞...</div>
  </div>

  <script>
    const col1 = document.getElementById('col1');
    const col2 = document.getElementById('col2');
    const msgDiv = document.getElementById('message');
    const notifySound = document.getElementById('notifySound');
    const sitdownSound = document.getElementById('sitdownSound');
    const soundBtn = document.getElementById('enableSound');

    let queue = [];
    let showingNotification = false;
    let lastIncludedSitdown = false;

    soundBtn.addEventListener('click', () => {
      notifySound.play().then(() => {
        notifySound.pause();
        notifySound.currentTime = 0;
        return sitdownSound.play();
      }).then(() => {
        sitdownSound.pause();
        sitdownSound.currentTime = 0;
        soundBtn.style.display = 'none';
      }).catch(e => {
        alert("–ë—Ä–∞—É–∑–µ—Ä –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–ª –∑–≤—É–∫. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –µ—â—ë —Ä–∞–∑.");
        console.error(e);
      });
    });

    async function fetchBackground() {
      try {
        const res = await fetch('https://script.google.com/macros/s/AKfycbxVVkIad26K7uwn36VfVO7xcCUe_OeGzC2flVEX3fKsDM9aCiftGdktNI0oLvH9Ho_w/exec?action=background');
        const raw = await res.text();
        const lines = raw.trim().split('\n');

        // –†–∞–∑–¥–µ–ª–∏–º —Å—Ç—Ä–æ–∫–∏ –Ω–∞ –¥–≤–µ –∫–æ–ª–æ–Ω–∫–∏
        const half = Math.ceil(lines.length / 2);
        const left = lines.slice(0, half).join('\n');
        const right = lines.slice(half).join('\n');

        col1.innerHTML = createColumnHtml(left);
        col2.innerHTML = createColumnHtml(right);

        const combined = lines.join(' ').toLowerCase();
        const containsSitdown = combined.includes('–º–æ–∂–µ–º —Å–∞–¥–∏—Ç—å—Å—è');

        if (containsSitdown && !lastIncludedSitdown) {
          showSitdown();
        }

        lastIncludedSitdown = containsSitdown;
      } catch (e) {
        col1.textContent = '–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏';
        col2.textContent = '';
        console.error(e);
      }
    }

    function createColumnHtml(data) {
      const rows = data.split('\n').map(line => {
        const parts = line.split(/\s{2,}/); // –†–∞–∑–¥–µ–ª–∏–º –ø–æ –Ω–µ—Å–∫–æ–ª—å–∫–∏–º –ø—Ä–æ–±–µ–ª–∞–º
        return `<div class="row"><span>${parts[0] || ''}</span><span>${parts[1] || ''}</span></div>`;
      }).join('');

      return rows;
    }

    function showSitdown() {
      if (showingNotification) return;

      showingNotification = true;
      msgDiv.textContent = '–ú–û–ñ–ï–ú –°–ê–î–ò–¢–¨–°–Ø';
      msgDiv.style.display = 'flex';
      document.body.style.background = 'white';
      document.body.style.color = 'black';

      sitdownSound.play().catch(console.error);

      setTimeout(() => {
        msgDiv.style.display = 'none';
        document.body.style.background = 'black';
        document.body.style.color = '#ddd';
        showingNotification = false;
      }, 20000);

      setTimeout(() => {
        sitdownSound.pause();
        sitdownSound.currentTime = 0;
      }, 5000);
    }

    async function fetchMessages() {
      if (showingNotification || queue.length > 0) return;

      try {
        const res = await fetch('https://script.google.com/macros/s/AKfycbxVVkIad26K7uwn36VfVO7xcCUe_OeGzC2flVEX3fKsDM9aCiftGdktNI0oLvH9Ho_w/exec');
        const messages = await res.json();

        const filtered = messages.filter(msg => !msg.toLowerCase().includes('–º–æ–∂–µ–º —Å–∞–¥–∏—Ç—å—Å—è'));

        if (filtered.length > 0) {
          queue.push(...filtered);
          showNextMessage();
        }
      } catch (e) {
        console.error('–û—à–∏–±–∫–∞ –ø–æ–ª—É—á–µ–Ω–∏—è —Å–æ–æ–±—â–µ–Ω–∏–π:', e);
      }
    }

    function showNextMessage() {
      if (queue.length === 0) return;

      showingNotification = true;
      const message = queue.shift();
      msgDiv.textContent = message;
      msgDiv.style.display = 'flex';
      document.body.style.background = 'white';
      document.body.style.color = 'black';

      notifySound.play().catch(console.error);

      setTimeout(() => {
        msgDiv.style.display = 'none';
        document.body.style.background = 'black';
        document.body.style.color = '#ddd';
        showingNotification = false;

        if (queue.length > 0) showNextMessage();
      }, 20000);

      setTimeout(() => {
        notifySound.pause();
        notifySound.currentTime = 0;
      }, 5000);
    }

    fetchBackground();
    setInterval(fetchBackground, 30000);
    setInterval(fetchMessages, 5000);
  </script>
</body>
</html>
